<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
 
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 80%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 80%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	 
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	 
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	width: 700px;
    font-size: 15px;
}
k{
    color: #990000;
	font-weight: bold;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px; 
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #C0F0E0;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;
	
}    
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}       
div.remark{
	background-color: #E3F2FD;	
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
} 

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}     

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed
	
}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>MirthExperiments</title></head>
    
<body>
<div id="body">
<h1>Mirth | experiments (in natMicroservices)<font size="5"></font> </h1>
<ul>
<li><a href="../../../natmaterial/health/userDocs/HealthReferences.html" target="web"> 
DISI - HealthReferences.html</a> (on <tt>natmaterial .... health/userDocs/</tt>) </li>
<li><a href="../../../natmaterial/health/userDocs/HealthReferences.html" target="web">DISI - HealthReferences.html </a></li>
 <li><a href="./MirthIntro.html" target="web"> 
DISI - MirthIntro.html</a> (on <tt>natMicroservices .... it.unibo.mirth.java/userDocs/MirthExperiments.html/</tt>) </li>
<li><a href="../../it.unibo.hapi2.2/userDocs/HapiUsage.html" target="web"> 
DISI - HapiUsage.html</a> (on <tt>natMicroservices .... it.unibo.hapi2.2/userDocs/</tt>) </li>
<li><a href="../../../Evolution/it.unibo.mirth.java/userDocs/HapiFhirUsage.html" target="web"> 
DISI - HapiFhirUsage.html</a> (on <tt>natMicroservices .... it.unibo.mirth.java/userDocs/</tt>) </li>

</ul>


<h2>Tools </h2>
<table style="width:98%">
<tbody>	
<tr><td style="width:25%">Using Mirth-API
</td>
<td ><a href="../src/it/unibo/mirth/java/MirthApiUsage.java" target="code">MirthApiUsage.java</a> (by DISI) </td>
</tr>

<tr><td>SmartHL7</td>
<td>
<a href="https://smarthl7.com/" target="web">Free HL7 Tool Viewer Editor Filter Sender Receiver</a> 
</td>
</tr>
 </tbody>
</table>

<h3>Installazione</h3>
<ol>
<li>Con riferimento a <a href="../workingok/compose-mysql-withvolume.yml" target="code">compose-mysql-withvolume.yml</a> si esegue
<pre>docker-compose -f compose-mysql-withvolume.yml up
</pre>
che installa:
<ul>
<li>il servizio <ks>db</ks> con immagine <k>mysql</k> settando nell'environment variabili relative al nome del db e alla password ed sponendo la porta <tt>3306</tt>.;</li>
<li>il servizio <ks>adminer</ks>  con immagine <k>adminer</k> con  porta <tt>8018/8080</tt> per la gestione dei db;</li>
<li>il servizio <ks>mc</ks> con dipendenza da <ks>db</ks>  e con immagine <k>nextgenhealthcare/connect</k>, 
settando nell'environment variabili relative al database. Inoltre definisce in <ks>volumes</ks> il mapping tra una directory del PC 
(<tt>C:\Progetti\natmaterial\mirth-connect-channel-examples\data\volumes\appdata</tt>) e una directory della VM
(<tt>/opt/connect/appdata</tt>).

<div class="remark">Includere nel file <a href="../.gitignore" target="code">.gitignore</a> la directory <k>workingok/data/volumes/appdata/temp</k> </div>
  </li>
</ul>
</li>

<li>
aprire <k>http://localhost:8080/</k>  e click on <tt>Launch Mirth Connect Administrator</tt> che scarica un file 
<ks>webstart.jnlp</ks>. Click su questo file e si apre  <tt>Mirth Connect Administrator Launcher</tt> che propone
<k>http://localhost:8080/webstart</k>. Premere il pulasante <k>Launch</k> per veder comparire <tt>Mirth Connect Login</tt>.
Immettere <tt>Username=admin</tt> e <tt>Password=admin</tt> per fare comparire una form da compilare.<br/><br/>
</li>

<li>aprire la GUI di <ks>adminer</ks> eseguendo <tt>localhost:8018</tt> e settando opportunamente i parametri: 
<pre>
Sistema: MySQL
Server: db
Utente: root
Password: root_password
Database: mirthdb
</pre>
Si consulta il db che è già popolato in quanto sosituisce <tt>derby</tt>. Si noti che la tabella <ks>CHANNEL</ks> e' vuota.<br/>
La tabella <ks>PERSON</ks> contiene dati, esportando la quale si ottiene il file 
 <a href="../workingok/PERSON.sql" target="code">PERSON.sql</a>.<br/> 
 Per l'uso del db all'interno di un canale Mirth, si rammenti:
 <pre>
 DRIVER: com.mysql.jdbc.Driver
 URL:    jdbc:mysql://db:3306/mirthdb</pre>
</li>

<li>carichiamo <i>user-defined Java code</i> secondo <a href="nextgen-connect-39-user-guide.pdf" target="code">nextgen-connect-39-user-guide.pdf (pag 157)</a>:
in <em>Settings->Resources</em> selezionare <k>Add Resource</k> con nome <tt>unibo</tt> e directory <tt>/opt/connect/appdata/unibolibs</tt>.
Premendo <k>refresh</k> si popola la finestra <i>Loaded Libraries</i> con tutti i file contenti nella dir specificata.
<br/>
<div class="remark">Now, restart the Mirth Connect server by clicking again on <ks>webstartmysql.jnlp</ks></div>
</li>


<li>carichiamo l'estensione FHIR Listner  predendo il file <k>fhir-3.9.0.b1285.zip</k> da una directory su PC.
<div class="remark">Now, restart the Mirth Connect server by clicking again on <ks>webstartmysql.jnlp</ks></div>

 </ol>

<h2>ESEMPI DI USO DI CANALI</h2>
Questi esempi nascono da <tt>C:\Progetti\natmaterial\mirth-connect-channel-examples</tt> preso da
<a href="https://github.com/nextgenhealthcare/connect-docker/tree/master/examples#mysql-with-volume.yml" target="web">nextgenhealthcare/connect-docker</a>.

 
<h3>Esempio: uso di TCP</h3>
 Si importa l'esempio HL7 to <a href="../workingok/channels/channelTcpBase.xml" target="code">channelTcpBase.xml</a>.<br/>
<hr/>Questo channel <em>BasicTcp</em> attende un messaggio (con datatype <em>raw</em>)  sulla porta TCP <tt>7001</tt> e 
lo invia a un <tt>Destinations</tt>
<hr/>
Il canale  visualizza il messaggio con il seguente codice Javascript:
<m><pre>
var input = connectorMessage.getRawData();
logger.info( input );
var R1  = <k>Packages.</k>it.unibo.mirth.java.MirthJava0.getText(input);  <kc>//RESPONSE</kc>
responseMap.put("R1", R1);
</pre></m> 
Il codice-utente si trova in <a href="../src/it/unibo/mirth/java/MirthJava0.java" target="code">MirthJava0.java</a>



<h4>Esempi di trasmissione</h4>

<ul>
<li>Un invio da programma: <a href="../src/it/unibo/mirth/java/TCPClientMirth.java" target="code">TCPClientMirth.java</a> 
<m><pre>
------------------- Messages -------------------
MSH|^~\&|NES|NINTENDO|TESTSYSTEM| ...
--------------------Mappings --------------------
Response d1 : SENT: JavaScript evaluation successful.
Response R1 : MirthJava0  received: MSH|^~\&|NES|NINTENDO|TESTSYSTEM| ... 
</pre></m>

</li>


<li>Un invio con <a href="https://curl.haxx.se/docs/httpscripting.html" target="web"><k>curl</k></a> (a command line tool that allows to transfer data across the network):
<m><pre>
curl  http://127.0.0.1:7001
curl -H "Content-Type: text/plain" http://127.0.0.1:7001
------------------- Messages -------------------
Riceve:
GET / HTTP/1.1
Host: 127.0.0.1:7001
User-Agent: curl/7.55.1
Accept: */*
--------------------Mappings --------------------
Response d1 : SENT: JavaScript evaluation successful.
Response R1 : MirthJava0  received: GET / HTTP/1.1Host: 127.0.0.1:7001User-Agent: curl/7.55.1Accept: */*

</pre></m></li>

</ul>


<h3>Esempio: uso di db</h3>
Si importa l'esempio <a href="../workingok/channels/HLtoMySQLdatabase.xml" target="code">HLtoMySQLdatabase.xml</a>.<br/> 
<hr/>Questo canale scrive periodicamente su DB (ogni 30 minuti) il conteuto di tutti i file <kc>*.hl7</kc> nella directory specificata in <tt>Source</tt>
nella ipotesi che questi file contegano dati con formato <ks>ADT-A01</ks> (<tt>Admit a patient</tt>).
<hr/>
<ol>
<li>
Il channel definisce in <tt>Destinations</tt>  un connector type di tipo <em>Database Writer</em> con il seguente codice Javascript:
<m><pre>
var dbConn;
try { dbConn = DatabaseConnectionFactory.createDatabaseConnection(
	<k>'com.mysql.jdbc.Driver'</k>,<k>'jdbc:mysql://db:3306/mirthdb','root','root_password'</k>);
	var result = <ks>dbConn.executeUpdate</ks>("INSERT INTO PERSON (USERNAME, FIRSTNAME, LASTNAME, LOGGED_IN) 
		VALUES ('"+$('Username')+"', '"+$('FirstName')+"', '"+$('LastName')+"', 0)");		
} finally { if (dbConn) {  dbConn.close(); }
}
</pre></m>
 </li>

<li><h4>Esempi di trasmissione</h4>
L'utente inserisce qualche file <kc>*.hl7</kc> (ad esempio <a href="../workingok/data/volumes/appdata/data1.hl7" target="code">data1.hl7</a>) nella
directory condivisa sul PC (<tt>C:\...\data\volumes\appdata</tt>). Poi:
<ul>
<li>Usando <ks>adminer</ks> si visualizzino i dati della tabella  <em>PERSON</em> </li>
<li>Fermare l'attivita' del canale con il comando <k>Stop</k>.</li>
</ul>

</li>
 
<li><h4>Entrare nel sistema</h4>
<m><pre>docker exec -it workingok_mc_1 bash
pwd ->                      /opt/connect
cd /home, ls ->             vuota
cd /opt/connect, ls ->      
<kc>appdata     custom-extensions  extensions  mcserver_base.vmoptions  mcservice.vmoptions        public_html          webapps
client-lib  custom-lib         logs        mcserver.vmoptions       mirth-server-launcher.jar  server-launcher-lib
conf        docs               mcserver    mcservice                public_api_html            server-lib</kc>
</pre></m></li>
</ol>


<h3>Esempio: da richiesta HTTP a messaggio HL7</h3>
Si importa l'esempio HL7 to <a href="../workingok/channels/json_to_hl7_dest_channel_writer.xml" target="code">json_to_hl7_dest_channel_writer.xml</a>.<br/> 
<hr/>
This channel receives a 'json' file over an 'HTTP' request, transforms it into an 'hl7' message, and sends it to another channel. 
<hr/>
Questo esempio permette di accedere ai codici dei canali usando <em>Channel Writer Settings</em> in <ttDestinations</tt>.
Ad esempio:
<m><pre>
channelTcpBase		                    d6b7c1b0-ac5e-4993-9570-45d8947ad76d
HLtoMySQLdatabase	                    7ef65bb8-203b-4a82-a312-33fb73cff9ed  
json_to_hl7_dest_channel_writer.xml     69c079fd-1cc3-469f-8f00-b4c51638fdde
</pre></m>

<ol>
<li>
Il channel definisce in <tt>Destinations</tt>:<k>Channel writer</k>. Noi selezioniamo <ks>channelTcpBase</ks>.
 </li>

<li><h4>Esempi di trasmissione</h4>
<ul>
<li>Un invio da programma: <a href="../src/it/unibo/mirth/java/HttpClientMirthPostJson.java" target="code">HttpClientMirthPostJson.java</a> 

<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
Il programma invia con HTTP la seguente  stringa JSON:
<m><pre>
  private static String msgJson = "{\r\n" + 
  		"    \"application_sending\" : \"EPICADTBO\",\r\n" + 
  		"    \"sending_facility\" : \"DH\",\r\n" + 
  		"    \"receiving_application\" : \"LABADT\",\r\n" + 
  		"    \"receiving_facility\" : \"DH\",\r\n" + 
  		"    \"time\": \"201301011226\",\r\n" + 
  		"    \"message_type\" : \"ADT^A01\",\r\n" + 
  		"    \"message_control_id\" : \"HL7MSG00001\",\r\n" + 
  		"    \"process_id\" : \"P\",\r\n" + 
  		"    \"version_id\": \"2.3\"\r\n" + 
  		"}";
</pre></m>

Questo dato è anche nel file  <a href="../workingok/channels/templates/json_template.json" target="code">json_template.json</a> 
<br/><br/>
Il risultato su Mirth è riportato qui sotto e qui a fianco.
<m><pre>
------------------- Messages Raw -------------------
{
  "application_sending" : "EPICADTBO",
  "sending_facility" : "DH",
  "receiving_application" : "LABADT",
  "receiving_facility" : "DH",
  "time" : "201301011226",
  "message_type" : "ADT^A01",
  "message_control_id" : "HL7MSG00001",
  "process_id" : "P",
  "version_id" : "2.3"
}



------------------- Messages Encoded -------------------
MSH|^~\&|EPICADTBO|DH|LABADT|DH|201301011226||ADT^A01|HL7MSG00001|P|2.3| 
PID||||||||||||||||||||
PD1|||||


--------------------Mappings --------------------
Response d2 : SENT: Message routed successfully 
	to channel id: d6b7c1b0-ac5e-4993-9570-45d8947ad76d

</td>
<td><m><m><pre>
------------------- Messages Transformed -------------------
&lt;HL7Message>
    &lt;MSH>
        &lt;MSH.1>|&lt;/MSH.1>
        &lt;MSH.2>^~\&amp;&lt;/MSH.2>
        &lt;MSH.3>
            &lt;MSH.3.1>EPICADTBO&lt;/MSH.3.1>
        &lt;/MSH.3>
        &lt;MSH.4>
            &lt;MSH.4.1>DH&lt;/MSH.4.1>
        &lt;/MSH.4>
        &lt;MSH.5>
            &lt;MSH.5.1>LABADT&lt;/MSH.5.1>
        &lt;/MSH.5>
        &lt;MSH.6>
            &lt;MSH.6.1>DH&lt;/MSH.6.1>
        &lt;/MSH.6>
        &lt;MSH.7>
            &lt;MSH.7.1>201301011226&lt;/MSH.7.1>
        &lt;/MSH.7>
        &lt;MSH.8/>
        &lt;MSH.9>ADT^A01&lt;/MSH.9>
        &lt;MSH.10>
            &lt;MSH.10.1>HL7MSG00001&lt;/MSH.10.1>
        &lt;/MSH.10>
        &lt;MSH.11>
            &lt;MSH.11.1>P&lt;/MSH.11.1>
        &lt;/MSH.11>
        &lt;MSH.12>
            &lt;MSH.12.1>2.3&lt;/MSH.12.1>
        &lt;/MSH.12>
        &lt;MSH.13>
            &lt;MSH.13.1/>
        &lt;/MSH.13>
    &lt;/MSH>
    &lt;PID>
        &lt;PID.1/>
        &lt;PID.2/>
        &lt;PID.3/>
        &lt;PID.4/>
        &lt;PID.5/>
        &lt;PID.6/>
        &lt;PID.7/>
        &lt;PID.8/>
        &lt;PID.9/>
        &lt;PID.10/>
        &lt;PID.11/>
        &lt;PID.12/>
        &lt;PID.13/>
        &lt;PID.14/>
        &lt;PID.15/>
        &lt;PID.16/>
        &lt;PID.17/>
        &lt;PID.18/>
        &lt;PID.19/>
        &lt;PID.20/>
    &lt;/PID>
    &lt;PD1>
        &lt;PD1.1/>
        &lt;PD1.2/>
        &lt;PD1.3/>
        &lt;PD1.4/>
        &lt;PD1.5/>
    &lt;/PD1>
&lt;/HL7Message>
</pre></m></m>
</td>
</tr>

<tr><td>
</td>
<td></td>
</tr>

 </tbody>
</table>
 
<li>Un invio mediante curl del contenuto del file <a href="../workingok/channels/templates/json_template.json" target="code">json_template.json</a>:
<pre>
curl -H "Content-Type: application/json" <k>--data @json_template.json</k>
	http://127.0.0.1:7003/api/channels/69c079fd-1cc3-469f-8f00-b4c51638fdde/messages
</pre>
 </li>
 
 
</li>
</ul>
</ol>


<h2 id="fhir">ESEMPI FHIR</h2>

 <h3>FHIR References</h3>
 <div class="remark">
<a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-structures-r4/" target="webcode">FHIR HAPI</a><br/>
<a href="https://fhir-drills.github.io/fhir-api.html" target="webcode">FHIR HAPI Tutorials</a><br/> 
<k>MIRTH</k>: &nbsp; &nbsp; 
<a href="http://www.mirthcorp.com/community/wiki/pages/viewpage.action?pageId=38798961" target="webcode">FHIR Mirth UserGuide</a>
&nbsp; &nbsp; &nbsp; &nbsp;
<a href="http://www.neonage.com/fhir/docs/javadocs/fhir-user-api/index.html?com/mirth/connect/connectors/fhir/" target="webcode">
FHIR Mirth</a>
&nbsp; &nbsp; | &nbsp; &nbsp; 
<a href="https://localhost:8443/javadocs/user-api/" target="webcode">user API</a>
&nbsp; &nbsp; &nbsp; &nbsp;
<a href="https://localhost:8443/api/" target="webcode">client API</a>
&nbsp; &nbsp; &nbsp; &nbsp;
<a href="https://web.archive.org/web/20181120184304/https://wso2.com/project/mashup/0.2/docs/e4xquickstart.html" target="webcode">E4X Quick Start Guide</a>
<br/><br/> 

<table style="width:98%">
<tbody>	
<tr>
 <td>
 <i>FhirContext</i><br/>
 <br/> <br/>  
 <hr/>
 <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-base/ca/uhn/fhir/context/FhirContext.html" target="webcode">FHIR HAPI FhirContext</a><br/>
 <br/> <br/>
 
 </td>
<td style="width:35%" >
<i>Patient</i><br/>
<a href="https://www.hl7.org/fhir/patient.html" target="webcode">FHIR Patient</a> (<k>Administration</k> module)<br/>
<a href="https://fhir-drills.github.io/simple-patient.html" target="webcode">Patient resource Tutorial</a>
<hr/>
<a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-structures-r4/org/hl7/fhir/r4/model/Patient.html" target="webcode">FHIR HAPI Patient</a><br/>
<a href="https://fhir-drills.github.io/fhir-api.html" target="webcode">FHIR HAPI Patient example</a><br/>
<a href="https://hapifhir.io/hapi-fhir/docs/client/examples.html" target="webcode">HAPI FHIR Client Examples</a><br/>
</td>
<td>
 <i>Bundle</i> <br/>

 <a href="https://www.hl7.org/fhir/bundle.html" target="webcode">FHIR Bundle</a>  (<k>Foundation</k> module)<br/>
<a href="https://fhir-drills.github.io/bundle.html" target="webcode">Bundle Tutorial</a>
<hr/>
<a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-structures-r4/undefined/org/hl7/fhir/r4/model/Bundle.html" target="webcode">FHIR HAPI Bundle</a><br/> 
<a href="https://fhir-drills.github.io/bundle.html" target="webcode">FHIR HAPI Bundle example</a> <br/> 
<a href="https://hapifhir.io/hapi-fhir/docs/client/examples.html" target="webcode">HAPI FHIR Client Examples</a><br/>
</td>
 

</tr>
 </tbody>
</table>
</div>

Questi esempi nascono da  <a href="../../../natmaterial/fhir-example-channels/channels" target="web">fhir-example-channels/channels</a>  preso da
<a href="https://github.com/nextgenhealthcare/fhir-example-channels" target="web">nextgenhealthcare/fhir-example-channels GIT</a>
( a repository of sample channels, code template libraries, and transformers that can be used with the  FHIR Connector Extension).

<h3>Esempio: FHIR Listener </h3>
Si importa l'esempio <a href="../channels/FHIR Listener.xml" target="code">FHIR Listener.xml</a>.<br/> 
<hr/>
This sample channel is intended as a <k>starting point</k> to teach you the basics of  FHIR resources/interactions and how the FHIR Listener works with them. 
<br/><m> 
The trial-use standard basically just tells you what to do with resources (create them, update them, etc.), 
and you can use Mirth Connect to customize the actual implementation however you wish.

This channel is dependent on the following code template libraries:
<ul>
<li>FHIR Helper Functions</li>
<li>FHIR DB Operations</li>
</ul>
</m> 
<hr/>
<h4>Esempi di trasmissione</h4>
Un invio da programma: <a href="../src/it/unibo/mirth/java/HttpFhirClientMirth.java" target="code">HttpFhirClientMirth.java</a>   (TO BE REFACTORED)
<br/>
Si può verificare la inserzione nel db di un paziente. 

<h3>Esempio: Convert HL7 to FHIR Patient - 1 </h3>
L'esempio e' quello descritto in
<a href="https://www.mirthcorp.com/community/wiki/display/mirth/HL7+v2.x+to+FHIR+Conversions+(R4)#HL7v2.xtoFHIRConversions(R4)-ConvertHL7toFHIRPatient-Example1" target="webcode">
FHIR Mirth UserGuide | Convert HL7 to FHIR Patient - Example 1</a>
<hr/>
This example channel uses the Iterator and FHIR Resource Builder transformer step types to take 
an HL7 v2.x ADT and create a FHIR Patient resource that represents the demographic information present in the message.
<hr/>

<h4>Esempi di trasmissione</h4>
Inviare il messaggio:
<pre>
MSH|^~\&|ADT1|SHM|SHMADT|SHM|200812091126|SECURITY|ADT^A01^ADT_A01|MSG00001|P|2.5|
EVN|A01|200812091126||
PID|1|1001|1001^5^M11^ADT1^MR^SHM~123456789^^^USSSA^SS||OHALLAHAN^COLLEEN^^||19850704|F||2106-3|1200 N ELM STREET^^NEWPORT BEACH^CA^92660-1020^US^H|OC|(949) 555-1234|(949) 555-5678||S||PATID1001^2^M10^ADT1^AN^A|123456789|U1234567^CA|
NK1|1|O'HALLAHAN^BRITTANY^M|SIS^SISTER||||N^NEXT-OF-KIN
PV1|1|I|2000^2012^01||||001122^ZOIDBERG^JOHN^|||SUR||||1|A0|
</pre>
e poi osservare <tt>Source Encoded data</tt> or <tt>Destination Raw data</tt>.

<h3>Esempio: Convert HL7 to FHIR Patient - 2 </h3>
<hr/>
This example channel uses the FHIR Resource Builder code template type to take 
an HL7 v2.x ADT and create a FHIR Patient resource that represents the demographic information present in the message. 
It accomplishes the same thing as the "Example 1" channel, but in a different way. 
By using code templates, you can keep your conversion logic separate from channels, 
and include those code templates on multiple channels as you see fit.
<hr/>



<h3>Esempi ....</h3>
<a href="https://nilkamaldp.wordpress.com/fhir-implementation-using-mirth/" target="code">FHIR Implementation Using Mirth</a>
explains what is reported in 
<a href="http://www.mirthcorp.com/community/wiki/pages/viewpage.action?pageId=38798957" target="code">Mirth Example Channel (R4)</a>.<br/>

<ul>
<li>This example channel depends on a database to store resource information. It is set up to support PostgreSQL or SQL Server, 
though you can modify the code templates to support others.</li>
<li>The example channel also relies on some configuration map properties to store database connection information. 
If you don't already have configuration map properties set, you can just import this file:
<pre>
PostgreSQL:
 The type of database server (postgres, sqlserver).fhirDBDatabaseType = postgres
 # The JDBC Driver class to use when connecting to the FHIR database.fhirDBDriver = org.postgresql.Driver
 # The JDBC connection URL to use when connecting to the FHIR database.fhirDBUrl = jdbc:postgresql://localhost:5432/fhirdb
 # The username to use when connecting to the FHIR database.fhirDBUsername = postgres
 # The password to use when connecting to the FHIR database.fhirDBPassword = postgres
 # The maximum amount of retry attempts when a database connection fails.fhirDBMaxRetries = 3
</pre>
Otherwise, you can just add them to the configuration map table.
</li>
<li>certain interactions have been selectively enabled for certain resource types</li>
<li>We use destination set filtering to decide in advance which destination to send a message to. 
Each destination is named according to one of the possible FHIR interactions, like 'create' or 'update.'</li>

<li>'create' destination: the JavaScript Writer takes a resource posted to the channel and stores it in the database.
It uses <tt>FhirResponseFactory</tt> to create a <tt>FhirResponse</tt> object. <br/><br/>
'read' destination: similar code to select resource data from the same database table and return the data in an appropriate 
<tt>FhirResponse</tt> object. 
<m><pre>
try {
    var fhirVersion = $('fhirVersion');
    var type = $('fhirType').toLowerCase();
    var id = $('fhirId');
    
    var result = getResource(type, id);
    
    if (result.next()) {
        var version = new String(result.getInt('version'));
        var data = getResultSetString(result, 'data');
        var contentType = getResultSetString(result, 'mimetype');
        var lastModified = getResultSetDate(result, 'last_modified');
        var deleted = result.getBoolean('deleted');

        if (deleted) {
            return createOperationOutcome('error', 'processing', $('fhirType') + ' ID ' + id + ' has been deleted.', fhirVersion, 410);
        } else {
            var response = FhirResponseFactory.getReadResponse(data, version, lastModified, 200, contentType);
            responseMap.put('response', response);
            return response.getMessage();
        }
    } else {
        return createOperationOutcome('error', 'processing', $('fhirType') + ' ID ' + id + ' not found.', fhirVersion, 404);
    }
} catch (e) {
    return createOperationOutcome('error', 'transient', 'Error reading resource.', fhirVersion, 500, e);
}
</pre></m>

</li>

<li>request the home page at the URL <ks>http://localhost:9001/r4/</ks>, or the conformance statement at the URL 
<ks>http://localhost:9001/r4/metadata</ks>. </li>

<li>create a new Patient resource. POST a request to <tt>http://localhost:9001/r4/Patient</tt>.
<br/>
If you choose an XML-formatted resource, use  <tt>application/fhir+xml</tt>  for the Content-Type. <br/>
If you choose JSON, use <tt>application/fhir+json</tt>.
<h4>Create a patient resource</h4>
See <a href="../fhir/examples/patient0.json" target="code">patient0.json</a> (general person)
taken from <a href="https://www.hl7.org/fhir/patient-example.json.html" target="code">FHIR R4 - Patient-example.json</a>
<br/><br/>
See also
<a href="https://hapifhir.io/hapi-fhir/docs/client/examples.html" target="web">HAPI FHIR Client Examples</a>
and 
<a href="http://hapi.fhir.org/" target="web">HAPI FHIR Public Server</a>
<br/><br/>
In whatever HTTP client you’re using, you should have received a 201 (Created) status code and also a Location header. <br/>
The <k>Location header</k> contains a URL telling the client where to issue a 'vread' interaction to retrieve the same resource you just created.
 </li>
 
 <li>copy that URL and issue a new GET request to it</li>
 
 <li>You can also create and read Binary resources</li>
</ul>


<pre>

//ADMINER STAND ALONE
docker-compose -f adminer.yml  up


From <kc>C:\Progetti\natmaterial\mirth-connect-channel-examples</kc>
docker-compose up

From <a href="https://github.com/nextgenhealthcare/connect-docker/tree/master/examples#mysql-with-volume.yml" target="web">nextgenhealthcare/connect-docker</a>
docker-compose -f compose-mysql-withvolume.yml up


curl -H "Content-Type: application/json" --data @json_template.json http://127.0.0.1:7002/api/channels/69c079fd-1cc3-469f-8f00-b4c51638fdde/messages

INSTALL FHIR
docker-compose -f compose-mysql-withvolume.yml stop
docker-compose -f compose-mysql-withvolume.yml start
localhost:8080		/webadmin/Index.action  Launch Mirth Connect Administrator 
save in C:\Progetti\natmaterial\mirth-connect-channel-examples\webstartmysql.jnlp and CLCK
Extension FHIR Listener OK

docker exec -it 99590a9ec384 bash
</pre>
  <br/><br/>
<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
</td>
<td>
</td>
</tr>

<tr><td>
</td>
<td></td>
</tr>

 </tbody>
</table>
 <br/><br/>
 </div>    


<!--
<h2>Channel TCP</h2>

<table style="width:98%">
<tbody>	
<tr>
<td style="width:25%" ><a href="../uniboChannels/channelTcp1.xml" target="code">channelTcp1</a>
</td>
<td>A TCP listener con data=<k>raw</k> on port=<tt>7001</tt>, Destination=<tt>JavaScrpt Writer</tt>:
<pre>
logger.info(connectorMessage.getRawData())
</pre>
A TCP sender: <a href="../src/it/unibo/mirth/java/TCPClientMirth.java" target="code">TCPClientMirth.java</a>.
<br/><br/>
</td>
</tr>

<tr>
<td style="width:25%" ><a href="../uniboChannels/channelTcp1.xml" target="code">channelTcp1</a>
</td>
<td>A TCP listener con data=<k>raw</k> on port=<tt>7002</tt>, Destination=<tt>Channel Writer</tt>, Transformer:
<pre>
var input = connectorMessage.getRawData();
logger.info( input );
var R1  = <k>Packages.</k>it.unibo.mirth.java.MirthJava0.getText(input);  <kc>//RESPONSE</kc>
responseMap.put("R1", R1);
</pre>
A user-defined Java library: <a href="../src/it/unibo/mirth/java/MirthJava0.java" target="code">MirthJava0.java</a>
<br/><br/>
<k>Problem</k>: not able to receive an answer sent by the TCP listener.
<br/><br/>
</td>
</tr>

<tr><td> 
</td>
<td> </td>
</tr>

<tr><td>
</td>
<td></td>
</tr>
 </tbody>
</table>


-->
 

<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI  
</div> 

</body>
</html>


 