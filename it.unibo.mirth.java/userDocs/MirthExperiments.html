<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
 
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 80%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 80%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	 
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	 
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	width: 700px;
    font-size: 15px;
}
k{
    color: #990000;
	font-weight: bold;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px; 
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #C0F0E0;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;
	
}    
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}       
div.remark{
	background-color: #E3F2FD;	
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
} 

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}     

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed
	
}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>MirthExperiments</title></head>
    
<body>
<div id="body">
<h1>Mirth | experiments (in natMicroservices)<font size="5"></font> </h1>
<ul>
<li><a href="../../../natmaterial/health/userDocs/HealthReferences.html" target="web"> 
DISI - HealthReferences.html</a> (on <tt>natmaterial .... health/userDocs/</tt>) </li>
<li><a href="../../../natmaterial/health/userDocs/HealthReferences.html" target="web">DISI - HealthReferences.html </a></li>
 <li><a href="./MirthIntro.html" target="web"> 
DISI - MirthIntro.html</a> (on <tt>natMicroservices .... it.unibo.mirth.java/userDocs/MirthExperiments.html/</tt>) </li>
<li><a href="../../it.unibo.hapi2.2/userDocs/HapiUsage.html" target="web"> 
DISI - HapiUsage.html</a> (on <tt>natMicroservices .... it.unibo.hapi2.2/userDocs/</tt>) </li>
<li><a href="../../../Evolution/it.unibo.mirth.java/userDocs/HapiFhirUsage.html" target="web"> 
DISI - HapiFhirUsage.html</a> (on <tt>natMicroservices .... it.unibo.mirth.java/userDocs/</tt>) </li>

</ul>


<h2>Tools </h2>
<table style="width:98%">
<tbody>	
<tr><td style="width:25%">Using Mirth-API
</td>
<td ><a href="../src/it/unibo/mirth/java/MirthApiUsage.java" target="code">MirthApiUsage.java</a> (by DISI) </td>
</tr>

<tr><td>SmartHL7</td>
<td>
<a href="https://smarthl7.com/" target="web">Free HL7 Tool Viewer Editor Filter Sender Receiver</a> 
</td>
</tr>
 </tbody>
</table>

<h2>Channel TCP</h2>

<table style="width:98%">
<tbody>	
<tr>
<td style="width:25%" ><a href="../uniboChannels/channelTcp1.xml" target="code">channelTcp1</a>
</td>
<td>A TCP listener con data=<k>raw</k> on port=<tt>7001</tt>, Destination=<tt>JavaScrpt Writer</tt>:
<pre>
logger.info(connectorMessage.getRawData())
</pre>
A TCP sender: <a href="../src/it/unibo/mirth/java/TCPClientMirth.java" target="code">TCPClientMirth.java</a>.
<br/><br/>
</td>
</tr>

<tr>
<td style="width:25%" ><a href="../uniboChannels/channelTcp1.xml" target="code">channelTcp1</a>
</td>
<td>A TCP listener con data=<k>raw</k> on port=<tt>7002</tt>, Destination=<tt>Channel Writer</tt>, Transformer:
<pre>
var input = connectorMessage.getRawData();
logger.info( input );
var R1  = <k>Packages.</k>it.unibo.mirth.java.MirthJava0.getText(input);  <kc>//RESPONSE</kc>
responseMap.put("R1", R1);
</pre>
A user-defined Java library: <a href="../src/it/unibo/mirth/java/MirthJava0.java" target="code">MirthJava0.java</a>
<br/><br/>
<k>Problem</k>: not able to receive an answer sent by the TCP listener.
<br/><br/>
</td>
</tr>

<tr><td> 
</td>
<td> </td>
</tr>

<tr><td>
</td>
<td></td>
</tr>
 </tbody>
</table>

<h2 id="fhir">FHIR</h2>
See <a href="../../../natmaterial/fhir-example-channels/channels" target="web">fhir-example-channels/channels</a> 
 (in natmaterial: a repository of sample channels, code template libraries, and transformers that can be used with the 
FHIR Connector Extension).<br/>

<h3>Example</h3>
<a href="https://nilkamaldp.wordpress.com/fhir-implementation-using-mirth/" target="code">FHIR Implementation Using Mirth</a>
explains what is reported in 
<a href="http://www.mirthcorp.com/community/wiki/pages/viewpage.action?pageId=38798957" target="code">Mirth Example Channel (R4)</a>.<br/>

<ul>
<li>This example channel depends on a database to store resource information. It is set up to support PostgreSQL or SQL Server, 
though you can modify the code templates to support others.</li>
<li>The example channel also relies on some configuration map properties to store database connection information. 
If you don't already have configuration map properties set, you can just import this file:
<pre>
PostgreSQL:
 The type of database server (postgres, sqlserver).fhirDBDatabaseType = postgres
 # The JDBC Driver class to use when connecting to the FHIR database.fhirDBDriver = org.postgresql.Driver
 # The JDBC connection URL to use when connecting to the FHIR database.fhirDBUrl = jdbc:postgresql://localhost:5432/fhirdb
 # The username to use when connecting to the FHIR database.fhirDBUsername = postgres
 # The password to use when connecting to the FHIR database.fhirDBPassword = postgres
 # The maximum amount of retry attempts when a database connection fails.fhirDBMaxRetries = 3
</pre>
Otherwise, you can just add them to the configuration map table.
</li>
<li>certain interactions have been selectively enabled for certain resource types</li>
<li>We use destination set filtering to decide in advance which destination to send a message to. 
Each destination is named according to one of the possible FHIR interactions, like 'create' or 'update.'</li>

<li>'create' destination: the JavaScript Writer takes a resource posted to the channel and stores it in the database.
It uses <tt>FhirResponseFactory</tt> to create a <tt>FhirResponse</tt> object. <br/><br/>
'read' destination: similar code to select resource data from the same database table and return the data in an appropriate 
<tt>FhirResponse</tt> object. 
<m><pre>
try {
    var fhirVersion = $('fhirVersion');
    var type = $('fhirType').toLowerCase();
    var id = $('fhirId');
    
    var result = getResource(type, id);
    
    if (result.next()) {
        var version = new String(result.getInt('version'));
        var data = getResultSetString(result, 'data');
        var contentType = getResultSetString(result, 'mimetype');
        var lastModified = getResultSetDate(result, 'last_modified');
        var deleted = result.getBoolean('deleted');

        if (deleted) {
            return createOperationOutcome('error', 'processing', $('fhirType') + ' ID ' + id + ' has been deleted.', fhirVersion, 410);
        } else {
            var response = FhirResponseFactory.getReadResponse(data, version, lastModified, 200, contentType);
            responseMap.put('response', response);
            return response.getMessage();
        }
    } else {
        return createOperationOutcome('error', 'processing', $('fhirType') + ' ID ' + id + ' not found.', fhirVersion, 404);
    }
} catch (e) {
    return createOperationOutcome('error', 'transient', 'Error reading resource.', fhirVersion, 500, e);
}
</pre></m>

</li>

<li>request the home page at the URL <ks>http://localhost:9001/r4/</ks>, or the conformance statement at the URL 
<ks>http://localhost:9001/r4/metadata</ks>. </li>

<li>create a new Patient resource. POST a request to <tt>http://localhost:9001/r4/Patient</tt>.
<br/>
If you choose an XML-formatted resource, use  <tt>application/fhir+xml</tt>  for the Content-Type. <br/>
If you choose JSON, use <tt>application/fhir+json</tt>.
<h4>Create a patient resource</h4>
See <a href="../fhir/examples/patient0.json" target="code">patient0.json</a> (general person)
taken from <a href="https://www.hl7.org/fhir/patient-example.json.html" target="code">FHIR R4 - Patient-example.json</a>
<br/><br/>
See also
<a href="https://hapifhir.io/hapi-fhir/docs/client/examples.html" target="web">HAPI FHIR Client Examples</a>
and 
<a href="http://hapi.fhir.org/" target="web">HAPI FHIR Public Server</a>
<br/><br/>
In whatever HTTP client you’re using, you should have received a 201 (Created) status code and also a Location header. <br/>
The <k>Location header</k> contains a URL telling the client where to issue a 'vread' interaction to retrieve the same resource you just created.
 </li>
 
 <li>copy that URL and issue a new GET request to it</li>
 
 <li>You can also create and read Binary resources</li>
</ul>

<h2>UN ESEMPIO CHE FUNZIONA</h2>
Questo esempio nasce da <tt>C:\Progetti\natmaterial\mirth-connect-channel-examples</tt> preso da
<a href="https://github.com/nextgenhealthcare/connect-docker/tree/master/examples#mysql-with-volume.yml" target="web">nextgenhealthcare/connect-docker</a>.

<h3>Installazione</h3>
<ol>
<li>Con riferimento a <a href="../workingok/compose-mysql-withvolume.yml" target="code">compose-mysql-withvolume.yml</a> si esegue
<pre>docker-compose -f compose-mysql-withvolume.yml up
</pre>
che installa:
<ul>
<li>il servizio <ks>db</ks> con immagine <k>mysql</k> settando nell'environment variabili relative al nome del db e alla password ed sponendo la porta <tt>3306</tt>.;</li>
<li>il servizio <ks>adminer</ks>  con immagine <k>adminer</k> con  porta <tt>8018/8080</tt> per la gestione dei db;</li>
<li>il servizio <ks>mc</ks> con dipendenza da <ks>db</ks>  e con immagine <k>nextgenhealthcare/connect</k>, 
settando nell'environment variabili relative al database. Inoltre definisce in <ks>volumes</ks> il mapping tra una directory del PC 
(<tt>C:\Progetti\natmaterial\mirth-connect-channel-examples\data\volumes\appdata</tt>) e una directory della VM
(<tt>/opt/connect/appdata</tt>).

<div class="remark">Includere nel file <a href="../.gitignore" target="code">.gitignore</a> la directory <k>workingok/data/volumes/appdata/temp</k> </div>
  </li>
</ul>
</li>

<li>
aprire <k>http://localhost:8080/</k>  e click on <tt>Launch Mirth Connect Administrator</tt> che scarica un file 
<ks>webstart.jnlp</ks>. Click su questo file e si apre  <tt>Mirth Connect Administrator Launcher</tt> che propone
<k>http://localhost:8080/webstart</k>. Premere il pulasante <k>Launch</k> per veder comparire <tt>Mirth Connect Login</tt>.
Immettere <tt>Username=admin</tt> e <tt>Password=admin</tt> per fare comparire una form da compilare.<br/><br/>
</li>

<li>aprire la GUI di <ks>adminer</ks> eseguendo <tt>localhost:8018</tt> e settando opportunamente i parametri: 
<pre>
Sistema: MySQL
Server: db
Utente: root
Password: root_password
Database: mirthdb
</pre>
Si consulta il db che è già popolato in quanto sosituisce <tt>derby</tt>. Si noti che la tabella <ks>CHANNEL</ks> e' vuota.<br/>
La tabella <ks>PERSON</ks> contiene dati, esportando la quale si ottiene il file 
 <a href="../workingok/PERSON.sql" target="code">PERSON.sql</a>.<br/><br/>
</li>

<li>carichiamo <i>user-defined Java code</i> secondo <a href="nextgen-connect-39-user-guide.pdf" target="code">nextgen-connect-39-user-guide.pdf (pag 157)</a>:
in <em>Settings->Resources</em> selezionare <k>Add Resource</k> con nome <tt>unibo</tt> e directory <tt>/opt/connect/appdata/unibolibs</tt>.
Premendo <k>refresh</k> si popola la finestra <i>Loaded Libraries</i> con tutti i file contenti nella dir specificata.
<br/>
<div class="remark">Now, restart the Mirth Connect server by clicking again on <ks>webstartmysql.jnlp</ks></div>
</li>


<li>carichiamo l'estensione FHIR Listner  predendo il file <k>fhir-3.9.0.b1285.zip</k> da una directory su PC.
<div class="remark">Now, restart the Mirth Connect server by clicking again on <ks>webstartmysql.jnlp</ks></div>

 </ol>
 
<h3>Esempio: uso di TCP</h3>
 Si importa l'esempio HL7 to <a href="../workingok/channelTcpBase.xml" target="code">channelTcpBase.xml</a>.<br/><br/>
Questo channel <em>BasicTcp</em> attende un messaggio (con datatype <em>raw</em>)  sulla porta TCP <tt>7001</tt> e 
lo invia a un <tt>Destinations</tt> che lo visualizza con il seguente codice Javascript:
<pre>
var input = connectorMessage.getRawData();
logger.info( input );
var R1  = <k>Packages.</k>it.unibo.mirth.java.MirthJava0.getText(input);  <kc>//RESPONSE</kc>
responseMap.put("R1", R1);
</pre> 
Il codice-utente si trova in <a href="../src/it/unibo/mirth/java/MirthJava0.java" target="code">MirthJava0.java</a>
<h4>Esempi di trasmissione</h4>

<ul>
<li>Un invio da programma: <a href="../it.unibo.mirth.java/TCPClientMirth.java" target="code">TCPClientMirth.java</a> 
<m><pre>
------------------- Messages -------------------
MSH|^~\&|NES|NINTENDO|TESTSYSTEM| ...
--------------------Mappings --------------------
Response d1 : SENT: JavaScript evaluation successful.
Response R1 : MirthJava0  received: MSH|^~\&|NES|NINTENDO|TESTSYSTEM| ... 
</pre></m>

</li>


<li>Un invio con <a href="https://curl.haxx.se/docs/httpscripting.html" target="web"><k>curl</k></a> (a command line tool that allows to transfer data across the network):
<m><pre>
curl  http://127.0.0.1:7001
curl -H "Content-Type: text/plain" http://127.0.0.1:7001
------------------- Messages -------------------
Riceve:
GET / HTTP/1.1
Host: 127.0.0.1:7001
User-Agent: curl/7.55.1
Accept: */*
--------------------Mappings --------------------
Response d1 : SENT: JavaScript evaluation successful.
Response R1 : MirthJava0  received: GET / HTTP/1.1Host: 127.0.0.1:7001User-Agent: curl/7.55.1Accept: */*

</pre></m></li>

</ul>


<h3>Esempio: uso di db</h3>
Si importa l'esempio <a href="../workingok/HLtoMySQLdatabase.xml" target="code">HLtoMySQLdatabase.xml</a>.<br/><br/>
Questo channel scrive periodicamente su DB (ogni 30 minuti) il conteuto di tutti i file <kc>*.hl7</kc> nella directory specificata in <tt>Source</tt>
nella ipotesi che questi file contegano dati con formato <ks>ADT-A01</ks> (<tt>Admit a patient</tt>).<br/><br/>

<ol>
<li>
Il channel definisce in <tt>Destinations</tt>  un connector type di tipo <em>Database Writer</em> con il seguente codice Javascript:
<pre>
var dbConn;
try { dbConn = DatabaseConnectionFactory.createDatabaseConnection(
		<k>'com.mysql.jdbc.Driver'</k>,<k>'jdbc:mysql://db:3306/mirthdb','root','root_password'</k>);
} finally { if (dbConn) {  dbConn.close(); }
}
</pre>
 </li>

<li>
L'utente inserisce qualche file <kc>*.hl7</kc> (ad esempio <a href="../workingok/data/volumes/appdata/data1.hl7" target="code">data1.hl7</a>) nella
directory condivisa sul PC (<tt>C:\...\data\volumes\appdata</tt>) .
</li>
<li>Usando <ks>adminer</ks> si visualizzino i dati della tabella  <em>PERSON</em> </li>
<li>Fermare l'attivita' del canale con il comando <k>Stop</k>.</li> 

</ol>


<h3>Esempio: da richiesta HTTP a messaggio HL7</h3>
Si importa l'esempio HL7 to <a href="../workingok/HLtoMySQLdatabase.xml" target="code">HLtoMySQLdatabase.xml</a>.<br/><br/>
This channel receives a 'json' file over an 'HTTP' request, transforms it into an 'hl7' message, and sends it to another channel.<br/><br/>

Questo esempio permette di accedere ai codici dei canali usando <em>Channel Writer Settings</em> in <ttDestinations</tt>.
Ad esempio:
<pre>
channelTcpBase		d6b7c1b0-ac5e-4993-9570-45d8947ad76d
HLtoMySQLdatabase	7ef65bb8-203b-4a82-a312-33fb73cff9ed  
</pre>

<ol>
<li>
Il channel definisce in <tt>Destinations</tt>   
<pre>
 </pre>
 </li>

<li>
 </li>
<li> </li>
 

</ol>

<pre>

//ADMINER STAND ALONE
docker-compose -f adminer.yml  up


From <kc>C:\Progetti\natmaterial\mirth-connect-channel-examples</kc>
docker-compose up

From <a href="https://github.com/nextgenhealthcare/connect-docker/tree/master/examples#mysql-with-volume.yml" target="web">nextgenhealthcare/connect-docker</a>
docker-compose -f compose-mysql-withvolume.yml up


curl -H "Content-Type: application/json" --data @json_template.json http://127.0.0.1:7002/api/channels/69c079fd-1cc3-469f-8f00-b4c51638fdde/messages

INSTALL FHIR
docker-compose -f compose-mysql-withvolume.yml stop
docker-compose -f compose-mysql-withvolume.yml start
localhost:8080		/webadmin/Index.action  Launch Mirth Connect Administrator 
save in C:\Progetti\natmaterial\mirth-connect-channel-examples\webstartmysql.jnlp and CLCK
Extension FHIR Listener OK

docker exec -it 99590a9ec384 bash
</pre>
  <br/><br/>
<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
</td>
<td>
</td>
</tr>

<tr><td>
</td>
<td></td>
</tr>

 </tbody>
</table>
 <br/><br/>
 </div>    

 

<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI  
</div> 

</body>
</html>


 